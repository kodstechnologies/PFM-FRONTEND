name: Deploy PFM Backend

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          cd PFM-BACKEND
          npm install --production

      - name: Build project (optional)
        run: |
          cd PFM-BACKEND
          npm run build || true

      - name: Update .env on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/PFM-BACKEND
            cat > .env <<'EOF'
PORT=8000
NODE_ENV=development
MONGODB_URI=${{ secrets.MONGODB_URI }}
MONGODB_DB_NAME=PFM
ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
ACCESS_TOKEN_VALIDATION_TIME=10d
REFRESH_TOKEN_VALIDATION_TIME=30d
FIREBASE_TYPE=${{ secrets.FIREBASE_TYPE }}
FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}"
FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}
SENDER_ID=${{ secrets.SENDER_ID }}
TEMPLATE_ID=${{ secrets.TEMPLATE_ID }}
CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
EOF

      - name: Restart PM2 on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/PFM-BACKEND
            pm2 stop pfm-backend || true
            pm2 start server.js --name pfm-backend
            pm2 save
